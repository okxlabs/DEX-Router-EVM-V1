pragma solidity 0.8.17;

import "forge-std/test.sol";
import "@dex/DexRouter.sol";

import "@dex/adapter/NativePmmAdapterV3.sol";

contract NativePmmAdapterV3Test is Test {
    address constant ETH = address(0);
    // WBNB address
    address constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant WBNB = 0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c;
    address constant USDT = 0xdAC17F958D2ee523a2206206994597C13D831ec7;

    // Test for ETH
    function test_tradeNativePmmV3_ETH() public {
        vm.createSelectFork("https://eth-mainnet.public.blastapi.io");
        vm.warp(1747712167);

        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapterV3(WETH)).code
        );

        NativePmmAdapterV3 adapter = NativePmmAdapterV3(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );


        deal(
            WETH,
            address(adapter),
            1000000000000000
        );

        // {
        //     "success": true,
        //     "orders": [{
        //         "pool": "0x6833e3e3f2a048df8d5dfdef466b73936b2224e6",
        //         "signer": "0x26a5652812905cc994009902c4b4dff950f96775",
        //         "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //         "sellerToken": "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
        //         "buyerToken": "0xdac17f958d2ee523a2206206994597c13d831ec7",
        //         "effectiveSellerTokenAmount": "1000000000000000",
        //         "sellerTokenAmount": "1000000000000000",
        //         "buyerTokenAmount": "2537032",
        //         "deadlineTimestamp": 1747796900,
        //         "nonce": 4538628127715491765,
        //         "quoteId": "fda52a9af05e22b628318c36b8e18d66",
        //         "multiHop": false,
        //         "signature": "",
        //         "externalSwapCalldata": "",
        //         "amountOutMinimum": "0",
        //         "widgetFee": {
        //             "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //             "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //             "feeRate": 0
        //         },
        //         "widgetFeeSignature": "bd504e281a44e9f9a417e7258d9bf6eb9a36f30eac59b9b96e04f0bdc33371eb75ed76435c2ba490902c63a002922f228e4a8a610d0b2d7ca4e83b0fcc3b053b1c"
        //     }],
        //     "widgetFee": {
        //         "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //         "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //         "feeRate": 0
        //     },
        //     "widgetFeeSignature": "",
        //     "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //     "amountIn": "1000000000000000",
        //     "amountOut": "2537032",
        //     "amountOutBeforeFee": "2537032",
        //     "fallbackSwapDataArray": null,
        //     "tokenTransferFeeOnPercent": 0,
        //     "txRequest": {
        //         "target": "0xa42C9F74AC8CB3d957ec1bD1C96B9CCEcC1950Aa",
        //         "calldata": "0xaf7065390000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006833e3e3f2a048df8d5dfdef466b73936b2224e600000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000038d7ea4c68000000000000000000000000000000000000000000000000000000000000026b64800000000000000000000000000000000000000000000000000000000682d43a40000000000000000000000000000000000000000000000003efc723c4813ffb5fda52a9af05e22b628318c36b8e18d660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bd504e281a44e9f9a417e7258d9bf6eb9a36f30eac59b9b96e04f0bdc33371eb75ed76435c2ba490902c63a002922f228e4a8a610d0b2d7ca4e83b0fcc3b053b1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //         "value": "0"
        //     },
        //     "source": [
        //         2
        //     ],
        //     "errorMessage": "",
        //     "router_version": "v1.0.0",
        //     "toWrap": false,
        //     "toUnwrap": false,
        //     "amountInOffset": 36,
        //     "amountOutMinimumOffset": 68
        // }

        adapter.sellBase(
            address(this),
            0xa42C9F74AC8CB3d957ec1bD1C96B9CCEcC1950Aa,
            // abi.encode(quote)
            hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006833e3e3f2a048df8d5dfdef466b73936b2224e600000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000038d7ea4c68000000000000000000000000000000000000000000000000000000000000026b64800000000000000000000000000000000000000000000000000000000682d43a40000000000000000000000000000000000000000000000003efc723c4813ffb5fda52a9af05e22b628318c36b8e18d660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bd504e281a44e9f9a417e7258d9bf6eb9a36f30eac59b9b96e04f0bdc33371eb75ed76435c2ba490902c63a002922f228e4a8a610d0b2d7ca4e83b0fcc3b053b1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        );

    }

    // Test for BSC
    function test_tradeNativePmmV3_BSC() public {
        vm.createSelectFork("https://bsc-dataseed.bnbchain.org");
        vm.warp(1747712167);

        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapterV3(WETH)).code
        );

        NativePmmAdapterV3 adapter = NativePmmAdapterV3(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );

        deal(
            WBNB,
            address(adapter),
            1000000000000000
        );

        // {
        //     "success": true,
        //     "orders": [{
        //         "pool": "0x5984c239c08834dbcf80d4fd741b4ed47ffe3d02",
        //         "signer": "0x26a5652812905cc994009902c4b4dff950f96775",
        //         "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //         "sellerToken": "0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c",
        //         "buyerToken": "0x55d398326f99059ff775485246999027b3197955",
        //         "effectiveSellerTokenAmount": "1000000000000000",
        //         "sellerTokenAmount": "1000000000000000",
        //         "buyerTokenAmount": "653231287000000000",
        //         "deadlineTimestamp": 1747797085,
        //         "nonce": 6764636644538963129,
        //         "quoteId": "8ca48b2e23f0ad1eb416f6b09739efa7",
        //         "multiHop": false,
        //         "signature": "",
        //         "externalSwapCalldata": "",
        //         "amountOutMinimum": "0",
        //         "widgetFee": {
        //             "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //             "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //             "feeRate": 0
        //         },
        //         "widgetFeeSignature": "5ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c"
        //     }],
        //     "widgetFee": {
        //         "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //         "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //         "feeRate": 0
        //     },
        //     "widgetFeeSignature": "",
        //     "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //     "amountIn": "1000000000000000",
        //     "amountOut": "653231287000000000",
        //     "amountOutBeforeFee": "653231287000000000",
        //     "fallbackSwapDataArray": null,
        //     "tokenTransferFeeOnPercent": 0,
        //     "txRequest": {
        //         "target": "0xb2d1F342D2049684Fb2f8c4eF320633415598333",
        //         "calldata": "0xaf7065390000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000910be6501ce660000000000000000000000000000000000000000000000000000000000682d445d0000000000000000000000000000000000000000000000005de0d1300855d4b98ca48b2e23f0ad1eb416f6b09739efa70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //         "value": "0"
        //     },
        //     "source": [
        //         1
        //     ],
        //     "errorMessage": "",
        //     "router_version": "v1.0.0",
        //     "toWrap": false,
        //     "toUnwrap": false,
        //     "amountInOffset": 36,
        //     "amountOutMinimumOffset": 68
        // }
        adapter.sellBase(
            address(this),
            0xb2d1F342D2049684Fb2f8c4eF320633415598333,
            // abi.encode(quote)
            hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000910be6501ce660000000000000000000000000000000000000000000000000000000000682d445d0000000000000000000000000000000000000000000000005de0d1300855d4b98ca48b2e23f0ad1eb416f6b09739efa70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        );
    }
}
