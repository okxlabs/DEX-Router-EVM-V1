pragma solidity 0.8.17;

import "forge-std/test.sol";
import "@dex/DexRouter.sol";

import {NativePmmAdapterV3} from "@dex/adapter/NativePmmAdapterV3.sol";

contract NativePmmAdapterV3Test is Test {
    address constant ETH = address(0);
    // WBNB address
    address constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant WBNB = 0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c;
    address constant USDT = 0xdAC17F958D2ee523a2206206994597C13D831ec7;

    uint256 internal constant ORIGIN_PAYER =
        0x3ca20afc2ccc0000000000000000000000000000000000000000000000000000;

    function test_nativePmmV3_refund() public {
        //https://app.blocksec.com/explorer/tx/bsc/0x9f12394e2b71fdf355b43bd37fc3ca8e30e0e4ee3164f7dec8e59640b444f8e9?line=22
        // vm.createSelectFork("https://bsc-dataseed.bnbchain.org", 54305006);
        // vm.createSelectFork("https://rpc-bsc.48.club", 54305006);
        vm.createSelectFork("https://api.zan.top/bsc-mainnet", 54305006 - 1);
        address dexRouter = 0x9b9efa5Efa731EA9Bbb0369E91fA17Abf249CFD4;
        NativePmmAdapterV3 adapter = new NativePmmAdapterV3(
            payable(address(WBNB))
        );
        vm.etch(
            0xb5F475B2860B4f70CD6B53396D784152568827A5,
            address(adapter).code
        );
        vm.prank(address(0xDFB5034B9a6512532Df7D88494556367BD0b9cFb));
        bytes
            memory data = hex"b80c2f09000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029776fcd48e9506f9421cec21cd48304ff56444400000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000df42ba4787bd520221d00000000000000000000000000000000000000000000000323dcb6166bd5867670000000000000000000000000000000000000000000000000000000068788a750000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000008e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000df42ba4787bd520221d00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000029776fcd48e9506f9421cec21cd48304ff5644440000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a96a96669295e85af046026bf714a26e840968890000000000000000000000000000000000000000000000000000000000000001000000000000000000000000fdeb3912c4904fccb6dc4d7724b432dfaa931bd30000000000000000000000000000000000000000000000000000000000000001000000000000000000002710fdeb3912c4904fccb6dc4d7724b432dfaa931bd3000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001900000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5f475b2860b4f70cd6b53396d784152568827a50000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5f475b2860b4f70cd6b53396d784152568827a50000000000000000000000000000000000000000000000000000000000000001000000000000000000002710b2d1f342d2049684fb2f8c4ef3206334155983330000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000b5f475b2860b4f70cd6b53396d784152568827a5000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000013135979b0acf585000000000000000000000000000000000000000000000034e2c6d90a524d37800000000000000000000000000000000000000000000000000000000068787ca1000000000000000000000000000000000000000000000000730f7965586ebff6ebf185470facd61f682fbb93216d1d4900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002200000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000034e2c6d90a524d378000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bb0705ebeeca4371a554e426b8d6f11096845bfe1888396b253685a71585c1774ba835d10cdf3fdab490ea059814837f51c1955ba24e76c2d5810c9b563a26601b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        dexRouter.call(data);
    }

    // Test for ETH
    function test_tradeNativePmmV3_ETH() public {
        vm.createSelectFork("https://eth-mainnet.public.blastapi.io", 23074110);
        // vm.warp(1753933211);

        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapterV3(WETH)).code
        );

        NativePmmAdapterV3 adapter = NativePmmAdapterV3(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );

        deal(USDT, address(adapter), 1000000);

        // {
        //     "amountIn": "1000000000000000",
        //     "amountInOffset": 36,
        //     "amountOut": "3857929",
        //     "amountOutMinimumOffset": 68,
        //     "orders": [{
        //         "amountOutMinimum": "3857929",
        //         "buyerToken": "0xdac17f958d2ee523a2206206994597c13d831ec7",
        //         "buyerTokenAmount": "3857929",
        //         "deadlineTimestamp": 1753933130,
        //         "decayExponent": 2,
        //         "decayStartTime": 1753933090,
        //         "effectiveSellerTokenAmount": "1000000000000000",
        //         "externalSwapCalldata": "",
        //         "maxPremiumBps": 200,
        //         "multiHop": false,
        //         "nonce": 5745067991428446716,
        //         "pool": "0x9aF2F3c0cD35283e13f7087e2b34b1444b57A44C",
        //         "quoteId": "9052ed5b33864a6126a33604398ad93c",
        //         "recipient": "0xe4cc081d7aa95b4a82b0a04301811d793a58989b",
        //         "sellerToken": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
        //         "sellerTokenAmount": "1000000000000000",
        //         "signature": "6750a45fa2ae4123a6ba6f65a9e79226d35ca16c1b706e32f998afa9e3c7c4a3556fabdc08ee194494c8a4352f93c8cf164abfbc457c00a99e1f0f747e8f01e81c",
        //         "signer": "0x26a5652812905cc994009902c4b4dff950f96775",
        //         "widgetFee": {
        //             "feeRate": "0",
        //             "feeRecipient": "0x6044EEf7179034319E2C8636ea885B37cBFa9aBa",
        //             "signer": "0xA3bD3Dfa76e5E58E47e45BCA54c2cc2fC27d4a83"
        //         },
        //         "widgetFeeSignature": "0fde85f90443dee791df70ff191465fb058b79748d92fc6f949783cdba8631005a8075c7b972cc5552f03322f65ee6c336cc35f12a0530784742b9f6420422b21b"
        //     }],
        //     "router_version": "2",
        //     "source": ["2"],
        //     "success": true,
        //     "toUnwrap": false,
        //     "toWrap": false,
        //     "txRequest": {
        //         "calldata": "0x69964e160000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009af2f3c0cd35283e13f7087e2b34b1444b57a44c00000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000e4cc081d7aa95b4a82b0a04301811d793a58989b000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000038d7ea4c6800000000000000000000000000000000000000000000000000000000000003ade0900000000000000000000000000000000000000000000000000000000003ade0900000000000000000000000000000000000000000000000000000000688ae54a0000000000000000000000000000000000000000000000004fba94e6478f39fc00000000000000000000000000000000000000000000000000000000688ae522000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000c89052ed5b33864a6126a33604398ad93c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000416750a45fa2ae4123a6ba6f65a9e79226d35ca16c1b706e32f998afa9e3c7c4a3556fabdc08ee194494c8a4352f93c8cf164abfbc457c00a99e1f0f747e8f01e81c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000410fde85f90443dee791df70ff191465fb058b79748d92fc6f949783cdba8631005a8075c7b972cc5552f03322f65ee6c336cc35f12a0530784742b9f6420422b21b00000000000000000000000000000000000000000000000000000000000000",
        //         "target": "0x0f9f2366C6157F2aCD3C2bFA45Cd9031c152D2Cf"
        //     }
        // }

        // adapter.sellBase(
        //     address(this),
        //     0x0f9f2366C6157F2aCD3C2bFA45Cd9031c152D2Cf,
        //     // abi.encode(quote)
        //     hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009af2f3c0cd35283e13f7087e2b34b1444b57a44c00000000000000000000000026a5652812905cc994009902c4b4dff950f967750000000000000000000000009795a07af691ff2d5bfadcdff1c42b748ea9474a000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000385c3954b780000000000000000000000000000000000000000000000000000000000003a910100000000000000000000000000000000000000000000000000000000003a910100000000000000000000000000000000000000000000000000000000688b18890000000000000000000000000000000000000000000000002081a6692461ee6400000000000000000000000000000000000000000000000000000000688b1861000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000c85025466bc7dc82233faa7e44197e8def00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000410d3ff003baee067b6e1d1a7cfdfa8a8ca0e6279e4c7c88be4c332f147191b73a28d4568ae0f70034f73b2feb91118c2d70e4ba1641d78a6e12b2f04ccb3d159b1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004131f939c4d395343e83fab2b7d5da3cc9a1c10ad3978b400ddff4c5c7a78cc8153d7a37946eea4582e2ca7daad5994a1f4b0c0b61ccef7cde3204b5a38b2b16ee1c00000000000000000000000000000000000000000000000000000000000000"
        // );
        // bytes memory data = abi.encodeWithSelector(
        //     NativePmmAdapterV3.sellBase.selector,
        //     0x6088d94C5a40CEcd3ae2D4e0710cA687b91c61d0,
        //     0x0f9f2366C6157F2aCD3C2bFA45Cd9031c152D2Cf,
        //     hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009af2f3c0cd35283e13f7087e2b34b1444b57a44c00000000000000000000000026a5652812905cc994009902c4b4dff950f967750000000000000000000000009795a07af691ff2d5bfadcdff1c42b748ea9474a000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000f85b2bb2fa130000000000000000000000000000000000000000000000000000f77ca4c31e51000000000000000000000000000000000000000000000000000000006891d5b30000000000000000000000000000000000000000000000005d582c48b975f780000000000000000000000000000000000000000000000000000000006891d5810000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002376fef060d93478c3763a13b4f4ae31ab00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000416f63c37cee1acc33060660965db9ff7cfc897ab9af3dc6fbb563ae40243d5ad277bdef966def877080dadfa40619388f2f0645f053fb6fcf54e66fa8a800ad551b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004162c24dffb29f5bb4d2c76bf09ddfa495280923ba1488574c6ce0bbe920d1bc6b0b206e06e3316f18fccfff5eca66709a1ad14a9177479af2a3867c50ead8be251b00000000000000000000000000000000000000000000000000000000000000"
        // );
        bytes memory originData = abi.encodeWithSelector(
            NativePmmAdapterV3.sellBase.selector,
            0x6088d94C5a40CEcd3ae2D4e0710cA687b91c61d0,
            0x0f9f2366C6157F2aCD3C2bFA45Cd9031c152D2Cf,
            hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009af2f3c0cd35283e13f7087e2b34b1444b57a44c00000000000000000000000026a5652812905cc994009902c4b4dff950f967750000000000000000000000009795a07af691ff2d5bfadcdff1c42b748ea9474a000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000f85b2bb2fa130000000000000000000000000000000000000000000000000000f77ca4c31e51000000000000000000000000000000000000000000000000000000006891d5b30000000000000000000000000000000000000000000000005d582c48b975f780000000000000000000000000000000000000000000000000000000006891d5810000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002376fef060d93478c3763a13b4f4ae31ab00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000416f63c37cee1acc33060660965db9ff7cfc897ab9af3dc6fbb563ae40243d5ad277bdef966def877080dadfa40619388f2f0645f053fb6fcf54e66fa8a800ad551b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004162c24dffb29f5bb4d2c76bf09ddfa495280923ba1488574c6ce0bbe920d1bc6b0b206e06e3316f18fccfff5eca66709a1ad14a9177479af2a3867c50ead8be251b00000000000000000000000000000000000000000000000000000000000000"
        );
        bytes memory finalData = bytes.concat(
            originData,
            abi.encodePacked(ORIGIN_PAYER + uint(uint160(address(this))))
        );
        (bool success, ) = address(adapter).call(finalData);
        require(success, "failed");
        // address(adapter).call(data);
        // console2.logBytes(data);
    }

    function test_tradeNativePmmV3_ARB() public {
        vm.createSelectFork("https://arbitrum.drpc.org", 363760229);
        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapterV3(WETH)).code
        );

        NativePmmAdapterV3 adapter = NativePmmAdapterV3(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );

        // {
        //     "amountIn": "5000000",
        //     "amountInOffset": 36,
        //     "amountOut": "1346747699091370",
        //     "amountOutMinimumOffset": 68,
        //     "orders": [{
        //         "amountOutMinimum": "1346747699091370",
        //         "buyerToken": "0x82af49447d8a07e3bd95bd0d56f35241523fbab1",
        //         "buyerTokenAmount": "1346747699091370",
        //         "deadlineTimestamp": 1754017399,
        //         "decayExponent": 2,
        //         "decayStartTime": 1754017344,
        //         "effectiveSellerTokenAmount": "5000000",
        //         "externalSwapCalldata": "",
        //         "maxPremiumBps": 150,
        //         "multiHop": false,
        //         "nonce": 6231521986488167780,
        //         "pool": "0xd3eAb36d3d16b4Afd66d7Cb231712e758D134329",
        //         "quoteId": "4b42dcff3df441a64692d1a6db42fc09",
        //         "recipient": "0x52Bb195Bc89a660073d890ff9EDC6726f97A981B",
        //         "sellerToken": "0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
        //         "sellerTokenAmount": "5000000",
        //         "signature": "8b0d82075f384f136049fe5a3dcbda35f11761cc0d018a5e16384e47ebc34c0163d196725f09e49bf0e0ad16a426062641295aecd781a30f9f05f6fe9fbf7a9e1c",
        //         "signer": "0x26a5652812905cc994009902c4b4dff950f96775",
        //         "widgetFee": {
        //             "feeRate": "0",
        //             "feeRecipient": "0x6044EEf7179034319E2C8636ea885B37cBFa9aBa",
        //             "signer": "0xA3bD3Dfa76e5E58E47e45BCA54c2cc2fC27d4a83"
        //         },
        //         "widgetFeeSignature": "c78b8dc769fc91e9f09ddd8df0aad86ddaf90d37b8b4ffc89564dbffd92b2ad64b682aa6c131b0715994d6e0e347c499fac2fc3681ce4a6921234d15097b56da1c"
        //     }],
        //     "router_version": "2",
        //     "source": ["3"],
        //     "success": true,
        //     "toUnwrap": false,
        //     "toWrap": false,
        //     "txRequest": {
        //         "calldata": "0x69964e16000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d3eab36d3d16b4afd66d7cb231712e758d13432900000000000000000000000026a5652812905cc994009902c4b4dff950f9677500000000000000000000000052bb195bc89a660073d890ff9edc6726f97a981b000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000004c4b400000000000000000000000000000000000000000000000000004c8dc2234d7aa0000000000000000000000000000000000000000000000000004c8dc2234d7aa00000000000000000000000000000000000000000000000000000000688c2e77000000000000000000000000000000000000000000000000567ad03b0ea9ed6400000000000000000000000000000000000000000000000000000000688c2e40000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000964b42dcff3df441a64692d1a6db42fc0900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000418b0d82075f384f136049fe5a3dcbda35f11761cc0d018a5e16384e47ebc34c0163d196725f09e49bf0e0ad16a426062641295aecd781a30f9f05f6fe9fbf7a9e1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041c78b8dc769fc91e9f09ddd8df0aad86ddaf90d37b8b4ffc89564dbffd92b2ad64b682aa6c131b0715994d6e0e347c499fac2fc3681ce4a6921234d15097b56da1c00000000000000000000000000000000000000000000000000000000000000",
        //         "target": "0x24400D2Ec38Db5881d03e16aEd463B1B48F7304A"
        //     }
        // }

        // ARB: USDT
        deal(
            0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9,
            address(adapter),
            1000000
        );
        bytes memory data = hex"000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d3eab36d3d16b4afd66d7cb231712e758d13432900000000000000000000000026a5652812905cc994009902c4b4dff950f9677500000000000000000000000052bb195bc89a660073d890ff9edc6726f97a981b000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000f9c62774d96b0000000000000000000000000000000000000000000000000000f886717fc8f8000000000000000000000000000000000000000000000000000000006891ca8b0000000000000000000000000000000000000000000000001b3697c537f880c7000000000000000000000000000000000000000000000000000000006891ca540000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003274b5d9799b0ec0bcb5bce7abd296110d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000414a2fbc9e9063b89c372402095cf8c4197beb7dc6f3325e92605512ca60fcf9ec5999b36eab5746fffb82917b119136844d516117e31311c5364f18339efa472f1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000418601a5fb274cb4f78ec66a74d9e6a55f5d5dedabbe21299a483ac57792ac3fa15d9cc83acf506d11e95cd57aa92c416dcce15336174bb99760887c0fceaed6a51c00000000000000000000000000000000000000000000000000000000000000";

        // adapter.sellBase(
        //     address(this),
        //     0x24400D2Ec38Db5881d03e16aEd463B1B48F7304A,
        //     // abi.encode(quote)
        //     hex"000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d3eab36d3d16b4afd66d7cb231712e758d13432900000000000000000000000026a5652812905cc994009902c4b4dff950f9677500000000000000000000000052bb195bc89a660073d890ff9edc6726f97a981b000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000f9c62774d96b0000000000000000000000000000000000000000000000000000f886717fc8f8000000000000000000000000000000000000000000000000000000006891ca8b0000000000000000000000000000000000000000000000001b3697c537f880c7000000000000000000000000000000000000000000000000000000006891ca540000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003274b5d9799b0ec0bcb5bce7abd296110d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000414a2fbc9e9063b89c372402095cf8c4197beb7dc6f3325e92605512ca60fcf9ec5999b36eab5746fffb82917b119136844d516117e31311c5364f18339efa472f1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000418601a5fb274cb4f78ec66a74d9e6a55f5d5dedabbe21299a483ac57792ac3fa15d9cc83acf506d11e95cd57aa92c416dcce15336174bb99760887c0fceaed6a51c00000000000000000000000000000000000000000000000000000000000000"
        // );
        bytes memory originData = abi.encodeWithSelector(
            NativePmmAdapterV3.sellBase.selector,
            0xfFb8322DEEeADF0d61589211493Fb2Dc668D3CC0,
            0x24400D2Ec38Db5881d03e16aEd463B1B48F7304A,
            data
        );
        bytes memory finalData = bytes.concat(
            originData,
            abi.encodePacked(ORIGIN_PAYER + uint(uint160(address(this))))
        );
        (bool success, ) = address(adapter).call(finalData);
        require(success, "failed");
    }

    // Test for BSC
    function test_tradeNativePmmV3_BSC() public {
        vm.createSelectFork("https://bsc-dataseed.bnbchain.org");
        vm.warp(1747712167);

        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapterV3(WETH)).code
        );

        NativePmmAdapterV3 adapter = NativePmmAdapterV3(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );

        deal(WBNB, address(adapter), 1000000000000000);

        // {
        //     "success": true,
        //     "orders": [{
        //         "pool": "0x5984c239c08834dbcf80d4fd741b4ed47ffe3d02",
        //         "signer": "0x26a5652812905cc994009902c4b4dff950f96775",
        //         "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //         "sellerToken": "0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c",
        //         "buyerToken": "0x55d398326f99059ff775485246999027b3197955",
        //         "effectiveSellerTokenAmount": "1000000000000000",
        //         "sellerTokenAmount": "1000000000000000",
        //         "buyerTokenAmount": "653231287000000000",
        //         "deadlineTimestamp": 1747797085,
        //         "nonce": 6764636644538963129,
        //         "quoteId": "8ca48b2e23f0ad1eb416f6b09739efa7",
        //         "multiHop": false,
        //         "signature": "",
        //         "externalSwapCalldata": "",
        //         "amountOutMinimum": "0",
        //         "widgetFee": {
        //             "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //             "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //             "feeRate": 0
        //         },
        //         "widgetFeeSignature": "5ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c"
        //     }],
        //     "widgetFee": {
        //         "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //         "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //         "feeRate": 0
        //     },
        //     "widgetFeeSignature": "",
        //     "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //     "amountIn": "1000000000000000",
        //     "amountOut": "653231287000000000",
        //     "amountOutBeforeFee": "653231287000000000",
        //     "fallbackSwapDataArray": null,
        //     "tokenTransferFeeOnPercent": 0,
        //     "txRequest": {
        //         "target": "0xb2d1F342D2049684Fb2f8c4eF320633415598333",
        //         "calldata": "0xaf7065390000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000910be6501ce660000000000000000000000000000000000000000000000000000000000682d445d0000000000000000000000000000000000000000000000005de0d1300855d4b98ca48b2e23f0ad1eb416f6b09739efa70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //         "value": "0"
        //     },
        //     "source": [
        //         1
        //     ],
        //     "errorMessage": "",
        //     "router_version": "v1.0.0",
        //     "toWrap": false,
        //     "toUnwrap": false,
        //     "amountInOffset": 36,
        //     "amountOutMinimumOffset": 68
        // }
        adapter.sellBase(
            address(this),
            0xb2d1F342D2049684Fb2f8c4eF320633415598333,
            // abi.encode(quote)
            hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000910be6501ce660000000000000000000000000000000000000000000000000000000000682d445d0000000000000000000000000000000000000000000000005de0d1300855d4b98ca48b2e23f0ad1eb416f6b09739efa70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        );
    }
}
