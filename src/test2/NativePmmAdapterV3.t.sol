pragma solidity 0.8.17;

import "forge-std/test.sol";
import "@dex/DexRouter.sol";

import "@dex/adapter/NativePmmAdapterV3.sol";

contract NativePmmAdapterV3Test is Test {
    address constant ETH = address(0);
    // WBNB address
    address constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant WBNB = 0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c;
    address constant USDT = 0xdAC17F958D2ee523a2206206994597C13D831ec7;

    function test_nativePmmV3_refund() public {
        //https://app.blocksec.com/explorer/tx/bsc/0x9f12394e2b71fdf355b43bd37fc3ca8e30e0e4ee3164f7dec8e59640b444f8e9?line=22
        // vm.createSelectFork("https://bsc-dataseed.bnbchain.org", 54305006);
        // vm.createSelectFork("https://rpc-bsc.48.club", 54305006);
        vm.createSelectFork("https://api.zan.top/bsc-mainnet", 54305006 - 1);
        address dexRouter = 0x9b9efa5Efa731EA9Bbb0369E91fA17Abf249CFD4;
        NativePmmAdapterV3 adapter = new NativePmmAdapterV3(
            payable(address(WBNB))
        );
        vm.etch(
            0xb5F475B2860B4f70CD6B53396D784152568827A5,
            address(adapter).code
        );
        vm.prank(address(0xDFB5034B9a6512532Df7D88494556367BD0b9cFb));
        bytes
            memory data = hex"b80c2f09000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029776fcd48e9506f9421cec21cd48304ff56444400000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000df42ba4787bd520221d00000000000000000000000000000000000000000000000323dcb6166bd5867670000000000000000000000000000000000000000000000000000000068788a750000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000008e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000df42ba4787bd520221d00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000029776fcd48e9506f9421cec21cd48304ff5644440000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a96a96669295e85af046026bf714a26e840968890000000000000000000000000000000000000000000000000000000000000001000000000000000000000000fdeb3912c4904fccb6dc4d7724b432dfaa931bd30000000000000000000000000000000000000000000000000000000000000001000000000000000000002710fdeb3912c4904fccb6dc4d7724b432dfaa931bd3000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001900000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5f475b2860b4f70cd6b53396d784152568827a50000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5f475b2860b4f70cd6b53396d784152568827a50000000000000000000000000000000000000000000000000000000000000001000000000000000000002710b2d1f342d2049684fb2f8c4ef3206334155983330000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000b5f475b2860b4f70cd6b53396d784152568827a5000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000013135979b0acf585000000000000000000000000000000000000000000000034e2c6d90a524d37800000000000000000000000000000000000000000000000000000000068787ca1000000000000000000000000000000000000000000000000730f7965586ebff6ebf185470facd61f682fbb93216d1d4900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002200000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000034e2c6d90a524d378000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bb0705ebeeca4371a554e426b8d6f11096845bfe1888396b253685a71585c1774ba835d10cdf3fdab490ea059814837f51c1955ba24e76c2d5810c9b563a26601b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        dexRouter.call(data);
    }

    // Test for ETH
    function test_tradeNativePmmV3_ETH() public {
        vm.createSelectFork("https://eth-mainnet.public.blastapi.io");
        vm.warp(1747712167);

        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapterV3(WETH)).code
        );

        NativePmmAdapterV3 adapter = NativePmmAdapterV3(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );

        deal(WETH, address(adapter), 1000000000000000);

        // {
        //     "success": true,
        //     "orders": [{
        //         "pool": "0x6833e3e3f2a048df8d5dfdef466b73936b2224e6",
        //         "signer": "0x26a5652812905cc994009902c4b4dff950f96775",
        //         "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //         "sellerToken": "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
        //         "buyerToken": "0xdac17f958d2ee523a2206206994597c13d831ec7",
        //         "effectiveSellerTokenAmount": "1000000000000000",
        //         "sellerTokenAmount": "1000000000000000",
        //         "buyerTokenAmount": "2537032",
        //         "deadlineTimestamp": 1747796900,
        //         "nonce": 4538628127715491765,
        //         "quoteId": "fda52a9af05e22b628318c36b8e18d66",
        //         "multiHop": false,
        //         "signature": "",
        //         "externalSwapCalldata": "",
        //         "amountOutMinimum": "0",
        //         "widgetFee": {
        //             "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //             "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //             "feeRate": 0
        //         },
        //         "widgetFeeSignature": "bd504e281a44e9f9a417e7258d9bf6eb9a36f30eac59b9b96e04f0bdc33371eb75ed76435c2ba490902c63a002922f228e4a8a610d0b2d7ca4e83b0fcc3b053b1c"
        //     }],
        //     "widgetFee": {
        //         "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //         "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //         "feeRate": 0
        //     },
        //     "widgetFeeSignature": "",
        //     "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //     "amountIn": "1000000000000000",
        //     "amountOut": "2537032",
        //     "amountOutBeforeFee": "2537032",
        //     "fallbackSwapDataArray": null,
        //     "tokenTransferFeeOnPercent": 0,
        //     "txRequest": {
        //         "target": "0xa42C9F74AC8CB3d957ec1bD1C96B9CCEcC1950Aa",
        //         "calldata": "0xaf7065390000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006833e3e3f2a048df8d5dfdef466b73936b2224e600000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000038d7ea4c68000000000000000000000000000000000000000000000000000000000000026b64800000000000000000000000000000000000000000000000000000000682d43a40000000000000000000000000000000000000000000000003efc723c4813ffb5fda52a9af05e22b628318c36b8e18d660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bd504e281a44e9f9a417e7258d9bf6eb9a36f30eac59b9b96e04f0bdc33371eb75ed76435c2ba490902c63a002922f228e4a8a610d0b2d7ca4e83b0fcc3b053b1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //         "value": "0"
        //     },
        //     "source": [
        //         2
        //     ],
        //     "errorMessage": "",
        //     "router_version": "v1.0.0",
        //     "toWrap": false,
        //     "toUnwrap": false,
        //     "amountInOffset": 36,
        //     "amountOutMinimumOffset": 68
        // }

        adapter.sellBase(
            address(this),
            0xa42C9F74AC8CB3d957ec1bD1C96B9CCEcC1950Aa,
            // abi.encode(quote)
            hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006833e3e3f2a048df8d5dfdef466b73936b2224e600000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000038d7ea4c68000000000000000000000000000000000000000000000000000000000000026b64800000000000000000000000000000000000000000000000000000000682d43a40000000000000000000000000000000000000000000000003efc723c4813ffb5fda52a9af05e22b628318c36b8e18d660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bd504e281a44e9f9a417e7258d9bf6eb9a36f30eac59b9b96e04f0bdc33371eb75ed76435c2ba490902c63a002922f228e4a8a610d0b2d7ca4e83b0fcc3b053b1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        );
    }

    // Test for BSC
    function test_tradeNativePmmV3_BSC() public {
        vm.createSelectFork("https://bsc-dataseed.bnbchain.org");
        vm.warp(1747712167);

        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapterV3(WETH)).code
        );

        NativePmmAdapterV3 adapter = NativePmmAdapterV3(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );

        deal(WBNB, address(adapter), 1000000000000000);

        // {
        //     "success": true,
        //     "orders": [{
        //         "pool": "0x5984c239c08834dbcf80d4fd741b4ed47ffe3d02",
        //         "signer": "0x26a5652812905cc994009902c4b4dff950f96775",
        //         "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //         "sellerToken": "0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c",
        //         "buyerToken": "0x55d398326f99059ff775485246999027b3197955",
        //         "effectiveSellerTokenAmount": "1000000000000000",
        //         "sellerTokenAmount": "1000000000000000",
        //         "buyerTokenAmount": "653231287000000000",
        //         "deadlineTimestamp": 1747797085,
        //         "nonce": 6764636644538963129,
        //         "quoteId": "8ca48b2e23f0ad1eb416f6b09739efa7",
        //         "multiHop": false,
        //         "signature": "",
        //         "externalSwapCalldata": "",
        //         "amountOutMinimum": "0",
        //         "widgetFee": {
        //             "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //             "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //             "feeRate": 0
        //         },
        //         "widgetFeeSignature": "5ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c"
        //     }],
        //     "widgetFee": {
        //         "signer": "0x89e56DB8eCAe8BfC7ADC790Ba7C8B1CcB17B74e6",
        //         "feeRecipient": "0xfa7f2f2ce037fc87846fd118e944db50c31875eb",
        //         "feeRate": 0
        //     },
        //     "widgetFeeSignature": "",
        //     "recipient": "0xbf381E1cBfdb0D02F3800010e490130D3dC73118",
        //     "amountIn": "1000000000000000",
        //     "amountOut": "653231287000000000",
        //     "amountOutBeforeFee": "653231287000000000",
        //     "fallbackSwapDataArray": null,
        //     "tokenTransferFeeOnPercent": 0,
        //     "txRequest": {
        //         "target": "0xb2d1F342D2049684Fb2f8c4eF320633415598333",
        //         "calldata": "0xaf7065390000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000910be6501ce660000000000000000000000000000000000000000000000000000000000682d445d0000000000000000000000000000000000000000000000005de0d1300855d4b98ca48b2e23f0ad1eb416f6b09739efa70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //         "value": "0"
        //     },
        //     "source": [
        //         1
        //     ],
        //     "errorMessage": "",
        //     "router_version": "v1.0.0",
        //     "toWrap": false,
        //     "toUnwrap": false,
        //     "amountInOffset": 36,
        //     "amountOutMinimumOffset": 68
        // }
        adapter.sellBase(
            address(this),
            0xb2d1F342D2049684Fb2f8c4eF320633415598333,
            // abi.encode(quote)
            hex"0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005984c239c08834dbcf80d4fd741b4ed47ffe3d0200000000000000000000000026a5652812905cc994009902c4b4dff950f96775000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc73118000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000910be6501ce660000000000000000000000000000000000000000000000000000000000682d445d0000000000000000000000000000000000000000000000005de0d1300855d4b98ca48b2e23f0ad1eb416f6b09739efa70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fa7f2f2ce037fc87846fd118e944db50c31875eb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415ad34e1e6b9d302408581f5f0a669ddd5d901a763fd1f9cdcc3a719d6d62e5da447f63240d08ec37c3dccc1227ef20188c411f2dec6afd00526e4fd86c33a7b91c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        );
    }
}
